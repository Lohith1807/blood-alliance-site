<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blood Alliance CWL Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #050816;
      --card: #0b1020;
      --border: #22263a;
      --primary: #f97316;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --radius: 18px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    header {
      padding-top: 5rem;
      padding-bottom: 3rem;
      text-align: center;
    }

    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .logo-wrap img {
      height: 160px;
      width: 160px;
      object-fit: contain;
      border-radius: 50%;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
      background: radial-gradient(circle, #111827, #020617);
    }

    h1 {
      font-size: 2.6rem;
      font-weight: 800;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #f97316, #22c55e, #f97316);
      -webkit-background-clip: text;
      color: transparent;
      margin-bottom: 0.75rem;
    }

    .subtitle {
      font-size: 1.05rem;
      color: var(--muted);
      max-width: 620px;
      margin: 0 auto;
    }

    .pill-row {
      margin-top: 0.75rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 0.75rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.08);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.7);
    }

    /* Controls / Filters */
    .controls {
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.7));
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 1.25rem 1.25rem 1rem;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .controls-group {
      flex: 1 1 220px;
      min-width: 200px;
    }

    .label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.55rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.4);
    }

    .search-wrap {
      position: relative;
    }

    .search-wrap input {
      padding-left: 2.1rem;
    }

    .search-icon {
      position: absolute;
      top: 50%;
      left: 0.7rem;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--muted);
    }

    .top-right-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.4rem;
      min-width: 150px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: linear-gradient(90deg, #22c55e, #f97316);
      color: #020617;
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 25px rgba(34, 197, 94, 0.4);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      white-space: nowrap;
    }

    .btn.disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .btn:not(.disabled):hover {
      transform: translateY(-1px) scale(1.02);
      filter: brightness(1.05);
      box-shadow: 0 16px 30px rgba(34, 197, 94, 0.6);
    }

    .btn small {
      font-size: 0.7rem;
      font-weight: 500;
      color: #0b1120;
      opacity: 0.8;
    }

    .status-text {
      font-size: 0.72rem;
      color: var(--muted);
    }

    .dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .dot.offline {
      background: var(--muted);
      box-shadow: none;
    }

    /* Cards list */
    .cards-wrapper {
      margin-top: 1.5rem;
      margin-bottom: 2.5rem;
    }

    .list-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.9rem;
      font-size: 0.8rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .list-meta strong {
      color: var(--accent);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.85rem;
    }

    .card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, rgba(249,115,22,0.16), transparent 55%),
                  radial-gradient(circle at bottom, rgba(34,197,94,0.06), transparent 55%),
                  rgba(15,23,42,0.95);
      padding: 1.1rem 1.1rem 0.85rem;
      box-shadow: 0 18px 40px rgba(15,23,42,0.75);
      transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s, background 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(248,250,252,0.35);
      box-shadow: 0 26px 60px rgba(15,23,42,0.9);
    }

    .card-main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
      gap: 1.25rem;
      align-items: center;
    }

    @media (max-width: 768px) {
      .card-main {
        grid-template-columns: 1fr;
        gap: 0.9rem;
      }
    }

    .section-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.2rem;
    }

    .player-name {
      font-size: 1.05rem;
      font-weight: 700;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
      margin-left: 0.35rem;
    }

    .registered {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .username {
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.6rem;
    }

    .user-id {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 0.2rem;
      word-break: break-all;
    }

    .clan-name {
      font-size: 0.98rem;
      font-weight: 600;
      text-align: right;
    }

    .clan-tag {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
      margin-top: 0.15rem;
    }

    .links {
      display: flex;
      justify-content: flex-end;
      gap: 0.45rem;
      margin-top: 0.7rem;
      flex-wrap: wrap;
    }

    .link-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: background 0.12s, border-color 0.12s, transform 0.12s;
      white-space: nowrap;
    }

    .link-btn:hover {
      background: rgba(30,64,175,0.9);
      border-color: rgba(248,250,252,0.7);
      transform: translateY(-1px);
    }

    .link-btn.main {
      border-color: rgba(249,115,22,0.9);
      background: linear-gradient(90deg, #f97316, #ec4899);
      color: #020617;
      font-weight: 600;
    }

    .link-btn.main:hover {
      background: linear-gradient(90deg, #fb923c, #f472b6);
    }

    .card-extra {
      border-top: 1px solid rgba(31,41,55,0.9);
      margin-top: 0.7rem;
      padding-top: 0.45rem;
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .extra-item span.label {
      opacity: 0.8;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem 2.5rem;
      border-radius: var(--radius);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      background: rgba(15,23,42,0.8);
      margin-top: 1.5rem;
    }

    .empty-state h3 {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    .empty-state p {
      font-size: 0.85rem;
      color: var(--muted);
      max-width: 420px;
      margin: 0 auto;
    }

    /* Footer */
    footer {
      padding: 1.7rem 0 2.3rem;
      border-top: 1px solid rgba(31, 41, 55, 0.85);
      background: radial-gradient(circle at top, rgba(15,23,42,0.85), #020617 60%);
    }

    .footer-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
      text-align: center;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .footer-brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .footer-brand img {
      height: 32px;
      width: 32px;
      border-radius: 10px;
      object-fit: contain;
      background: #020617;
      box-shadow: 0 0 14px rgba(248,250,252,0.3);
    }

    .discord-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      text-decoration: none;
      margin-top: 0.2rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(96,165,250,0.9);
      background: rgba(15,23,42,0.9);
      color: #bfdbfe;
      font-size: 0.78rem;
      transition: background 0.12s, border-color 0.12s, transform 0.12s;
    }

    .discord-link:hover {
      background: #1d4ed8;
      border-color: #93c5fd;
      transform: translateY(-1px);
    }

    .toast {
      position: fixed;
      bottom: 1.4rem;
      right: 1.4rem;
      background: rgba(15,23,42,0.95);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.8rem;
      max-width: 260px;
      color: var(--text);
      box-shadow: 0 18px 35px rgba(15,23,42,0.9);
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.15s, transform 0.15s;
      z-index: 50;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .toast-error {
      border-color: rgba(248,113,113,0.8);
    }

    .toast-error .toast-title {
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HERO -->
    <header>
      <div class="logo-wrap">
        <!-- Optional: put blood-alliance-logo.png in same folder -->
        <img src="blood-alliance-logo.png" alt="Blood Alliance Logo" onerror="this.style.display='none'" />
      </div>
      <h1>Blood Alliance CWL Info</h1>
      <p class="subtitle">
        Check your Lazy CWL registration and assigned clan. Use filters and search to find your profile.
      </p>
      <div class="pill-row">
        <span class="pill">Lazy CWL</span>
        <span class="pill">Sheet2API Powered</span>
        <span class="pill">Live Player Lookup</span>
      </div>
    </header>

    <!-- CONTROLS -->
    <section class="controls">
      <div class="controls-row">
        <div class="controls-group">
          <div class="label">Clan</div>
          <select id="filterClan">
            <option value="all">All Clans</option>
          </select>
        </div>

        <div class="controls-group search-wrap">
          <div class="label">Search</div>
          <span class="search-icon">üîç</span>
          <input
            type="text"
            id="searchInput"
            placeholder="Search by player name, tag, Discord username or ID..."
          />
        </div>

        <div class="top-right-controls">
          <button id="refreshBtn" class="btn">
            ‚ü≥ Refresh
            <small>from CWL sheet</small>
          </button>
          <div class="status-text">
            <span id="statusDot" class="dot offline"></span>
            <span id="statusText">Waiting to load data‚Ä¶</span>
          </div>
        </div>
      </div>
    </section>

    <!-- LIST / CARDS -->
    <section class="cards-wrapper">
      <div class="list-meta">
        <div>
          Showing <strong><span id="shownCount">0</span></strong> players
          <span id="totalCountWrap">(out of <span id="totalCount">0</span>)</span>
        </div>
        <div id="lastUpdatedText">Last updated: --</div>
      </div>

      <div id="cardsGrid" class="cards-grid">
        <!-- Player cards injected by JS -->
      </div>

      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No players found</h3>
        <p>
          Try changing your filters or searching with a different name, tag or Discord username.
        </p>
      </div>
    </section>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <img src="blood-alliance-logo.png" alt="Blood Alliance" onerror="this.style.display='none'">
          <div>
            <div>Blood Alliance &middot; Lazy CWL</div>
            <a
              href="https://discord.gg/gGGEs5SV9z"
              target="_blank"
              class="discord-link"
            >
              <span>Join our Discord</span>
            </a>
          </div>
        </div>
        <div>¬© 2025 Blood Alliance. All rights reserved.</div>
      </div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="toast-title" id="toastTitle"></div>
    <div id="toastMessage"></div>
  </div>

  <script>
    // === CONFIG: Sheet2API endpoint ===
    const API_URL = "https://sheet2api.com/v1/90H79qclQcqu/cwl_list";
    const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds

    // DOM Elements
    const filterClan = document.getElementById("filterClan");
    const searchInput = document.getElementById("searchInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const cardsGrid = document.getElementById("cardsGrid");
    const emptyState = document.getElementById("emptyState");
    const shownCount = document.getElementById("shownCount");
    const totalCount = document.getElementById("totalCount");
    const totalCountWrap = document.getElementById("totalCountWrap");
    const lastUpdatedText = document.getElementById("lastUpdatedText");
    const statusText = document.getElementById("statusText");
    const statusDot = document.getElementById("statusDot");
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMessage = document.getElementById("toastMessage");

    let allPlayers = [];
    let isLoading = false;
    let autoRefreshTimer = null;

    function showToast(title, message, isError) {
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toast.classList.toggle("toast-error", !!isError);
      toast.classList.add("visible");
      setTimeout(() => {
        toast.classList.remove("visible");
      }, 3000);
    }

    function setLoading(loading) {
      isLoading = loading;
      if (loading) {
        refreshBtn.classList.add("disabled");
        refreshBtn.textContent = "‚ü≥ Loading‚Ä¶";
        statusText.textContent = "Loading data from CWL sheet‚Ä¶";
        statusDot.classList.add("offline");
      } else {
        refreshBtn.classList.remove("disabled");
        refreshBtn.textContent = "‚ü≥ Refresh";
      }
    }

    function getField(row, name) {
      // Direct mapping with exact column names
      return row[name] ?? "";
    }

    async function loadData(showToastFlag) {
      if (isLoading) return;
      setLoading(true);
      try {
        const res = await fetch(API_URL);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        const players = (data || []).map((row, index) => {
          const playerName = getField(row, "Player Name");
          const playerTag = getField(row, "Player Tag");
          const userId = getField(row, "Discord User ID");
          const username = getField(row, "Discord Username");
          const assignedClan = getField(row, "Assigned Clan");
          const assignedClanTag = getField(row, "Assigned Clan Tag");
          const registeredAt = getField(row, "Registered At");

          return {
            id: index + 1,
            playerName,
            playerTag,
            userId,
            username,
            assignedClan,
            assignedClanTag,
            registeredAt
          };
        }).filter(p => p.playerName);

        allPlayers = players;

        if (players.length) {
          statusText.textContent = "Data loaded.";
          statusDot.classList.remove("offline");
        } else {
          statusText.textContent = "No data found.";
          statusDot.classList.add("offline");
        }

        const now = new Date();
        lastUpdatedText.textContent = "Last updated: " + now.toLocaleString();

        populateFilters();
        renderList();

        totalCount.textContent = String(allPlayers.length);
        totalCountWrap.style.display = "inline";

        if (showToastFlag) {
          showToast("Data refreshed", "Player list updated from CWL sheet.", false);
        } else {
          showToast("Welcome", "CWL data loaded successfully.", false);
        }

      } catch (err) {
        console.error("Error fetching sheet:", err);
        statusText.textContent = "Failed to load data.";
        statusDot.classList.add("offline");
        showToast("Error", "Failed to load data from CWL sheet.", true);
      } finally {
        setLoading(false);
      }
    }

    function populateFilters() {
      const clansMap = new Map();
      allPlayers.forEach(p => {
        if (!p.assignedClanTag) return;
        if (!clansMap.has(p.assignedClanTag)) {
          clansMap.set(p.assignedClanTag, p.assignedClan || p.assignedClanTag);
        }
      });

      const selectedClan = filterClan.value || "all";
      filterClan.innerHTML = '<option value="all">All Clans</option>';
      Array.from(clansMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .forEach(([tag, name]) => {
          const opt = document.createElement("option");
          opt.value = tag;
          opt.textContent = `${name} (${tag})`;
          filterClan.appendChild(opt);
        });
      if (selectedClan && [...filterClan.options].some(o => o.value === selectedClan)) {
        filterClan.value = selectedClan;
      }
    }

    function buildPlayerCard(player) {
      const card = document.createElement("div");
      card.className = "card";

      const main = document.createElement("div");
      main.className = "card-main";
      card.appendChild(main);

      // Left side: Player + Discord + Registered
      const left = document.createElement("div");

      const playerLabel = document.createElement("div");
      playerLabel.className = "section-label";
      playerLabel.textContent = "Player";
      left.appendChild(playerLabel);

      const nameRow = document.createElement("div");
      nameRow.className = "player-name";
      nameRow.innerHTML = `${escapeHtml(player.playerName)} <span class="badge">${escapeHtml(player.playerTag || "No tag")}</span>`;
      left.appendChild(nameRow);

      const reg = document.createElement("div");
      reg.className = "registered";
      reg.textContent = player.registeredAt ? `Registered: ${player.registeredAt}` : "";
      left.appendChild(reg);

      const discLabel = document.createElement("div");
      discLabel.className = "section-label";
      discLabel.style.marginTop = "0.9rem";
      discLabel.textContent = "Discord";
      left.appendChild(discLabel);

      const username = document.createElement("div");
      username.className = "username";
      username.textContent = player.username || "Not provided";
      left.appendChild(username);

      const userId = document.createElement("div");
      userId.className = "user-id";
      userId.textContent = player.userId ? `ID: ${player.userId}` : "";
      left.appendChild(userId);

      main.appendChild(left);

      // Right side: Clan + buttons
      const right = document.createElement("div");

      const clanLabel = document.createElement("div");
      clanLabel.className = "section-label";
      clanLabel.style.textAlign = "right";
      clanLabel.textContent = "Clan";
      right.appendChild(clanLabel);

      const clanName = document.createElement("div");
      clanName.className = "clan-name";
      clanName.textContent = player.assignedClan || "No clan";
      right.appendChild(clanName);

      const clanTag = document.createElement("div");
      clanTag.className = "clan-tag";
      clanTag.textContent = player.assignedClanTag || "";
      right.appendChild(clanTag);

      const links = document.createElement("div");
      links.className = "links";

      const clanBtn = document.createElement("a");
      clanBtn.className = "link-btn";
      clanBtn.href = getClanLink(player.assignedClanTag);
      clanBtn.target = "_blank";
      clanBtn.rel = "noopener noreferrer";
      clanBtn.textContent = "Open Clan";
      links.appendChild(clanBtn);

      const playerBtn = document.createElement("a");
      playerBtn.className = "link-btn main";
      playerBtn.href = getPlayerLink(player.playerTag);
      playerBtn.target = "_blank";
      playerBtn.rel = "noopener noreferrer";
      playerBtn.textContent = "Open Player";
      links.appendChild(playerBtn);

      right.appendChild(links);
      main.appendChild(right);

      return card;
    }

    function getPlayerLink(tag) {
      if (!tag) return "https://link.clashofclans.com/";
      const cleaned = tag.replace("#", "");
      return `https://link.clashofclans.com/?action=OpenPlayerProfile&tag=%23${encodeURIComponent(cleaned)}`;
    }

    function getClanLink(tag) {
      if (!tag) return "https://link.clashofclans.com/";
      const cleaned = tag.replace("#", "");
      return `https://link.clashofclans.com/?action=OpenClanProfile&tag=%23${encodeURIComponent(cleaned)}`;
    }

    function renderList() {
      const selectedClan = filterClan.value || "all";
      const q = (searchInput.value || "").trim().toLowerCase();

      const filtered = allPlayers.filter(p => {
        const matchClan =
          selectedClan === "all" || (p.assignedClanTag && p.assignedClanTag === selectedClan);

        const haystack = [
          p.playerName,
          p.playerTag,
          p.username,
          p.userId,
          p.assignedClan,
          p.assignedClanTag
        ]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();

        const matchSearch = q === "" || haystack.includes(q);
        return matchClan && matchSearch;
      });

      cardsGrid.innerHTML = "";
      if (filtered.length === 0) {
        emptyState.style.display = "block";
        shownCount.textContent = "0";
      } else {
        emptyState.style.display = "none";
        filtered.forEach(p => {
          cardsGrid.appendChild(buildPlayerCard(p));
        });
        shownCount.textContent = String(filtered.length);
      }
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Event listeners
    filterClan.addEventListener("change", renderList);
    searchInput.addEventListener("input", renderList);

    refreshBtn.addEventListener("click", function () {
      if (!isLoading) {
        loadData(true);
      }
    });

    function startAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
      autoRefreshTimer = setInterval(() => {
        loadData(false);
      }, AUTO_REFRESH_INTERVAL);
    }

    // Initial load
    loadData(false);
    startAutoRefresh();
  </script>
</body>
</html>
